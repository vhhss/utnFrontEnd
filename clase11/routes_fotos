const express = require('express');

const rutas_fotos = express.Router();

//AGREGO FILE SYSTEM
const fs = require('fs');

const multer = require('multer');
const mime = require('mime-types');

const PATH_ARCHIVO_FOTOS = "./archivos/productos_fotos.json";

const upload = multer({
    storage: multer.diskStorage({
                destination: "public/fotos/",
            })
});

//LISTAR

rutas_fotos.get('/', (request, response) => {

    let retorno = {};

    if(fs.existsSync(PATH_ARCHIVO_FOTOS)){

        const data = fs.readFileSync(PATH_ARCHIVO_FOTOS);
        retorno = JSON.parse(data);
    }

     response.json(retorno);

});

//AGREGAR
rutas_fotos.post('/', upload.single("foto"), (request, response)=>{

    //response.send('POST - servidor Node.JS');

    let estado = 200;
    const obj_resp  = {"exito" : false, "mesaje" : "No se pudo agregar"};
    //const producto = { ...request.body };

    let file = request.file;
    let ext = mime.extension(file.mimetype)
    let obj = JSON.parse(request.body.obj_producto)
    let path = file.destination + obj.codigo + "." + ext

    fs.renameSync(request.file.path, path);

    obj.path = path.split("public/")[1];

    if(fs.existsSync(PATH_ARCHIVO_FOTOS)){

        const data = fs.readFileSync(PATH_ARCHIVO_FOTOS);
        const productos = JSON.parse(data);

        productos.push(obj)

        fs.writeFileSync(PATH_ARCHIVO_FOTOS, JSON.stringify(productos, null, 2))

        estado = 201;
        obj_resp.mensaje = "el prod con foto fue agregado con Ã©xito.";
    }

    response.json(producto);
    //response.status(estado).json(obj_resp);
});

//MODIFICAR
rutas_fotos.put('/', (request, response)=>{

    let estado = 200;
    const obj_resp  = {"exito" : false, "mesaje" : "No se pudo modificar"};
    const producto = { ...request.body };

    let file = request.file;
    let ext = mime.extension(file.mimetype)
    let obj = JSON.parse(request.body.obj_producto)
    let path = file.destination + obj.codigo + "." + ext

    fs.renameSync(request.file.path, path);

    if(fs.existsSync(PATH_ARCHIVO_FOTOS)){

        const data = fs.readFileSync(PATH_ARCHIVO_FOTOS);
        const productos = JSON.parse(data);

        const indice = productos.findIndex(p => parseInt(p.codigo) === parseInt(producto.codigo))
        
        if(indice === -1){
            obj_resp.mensaje = "No se ha encontrado el product " + producto.codigo;
        }else{
            productos[indice] = producto;
            fs.writeFileSync(PATH_ARCHIVO_FOTOS, JSON.stringify(productos, null, 2))

            estado = 201;
            obj_resp.mensaje = "el prod fue modificado con exito.";
            
        }
        
    }

    response.json(producto);
    //response.status(estado).json(obj_resp);

});

module.exports = rutas_fotos;